import {Emulator} from "../../src/Emulator.ts";
import {describe, expect, test} from "bun:test";
import {parseDisplay} from "../utils/parseDisplay.ts";
import {NoDisplay} from "../../src/Displays/NoDisplay.ts";

const file = await Bun.file("lib/chip8-test-suite/bin/4-flags.ch8").bytes();

const resultScreenState = `
█.█..█..██..██..█.█...██....................███.................
███.█.█.█.█.█.█.█.█....█...█.█.█.█.█.█........█..█.█.█.█.█.█....
█.█.███.██..██...█.....█...██..██..██.......██...██..██..██.....
█.█.█.█.█...█....█....███..█...█...█........███..█...█...█......
................................................................
███...................█.█...................███.................
.██..█.█.█.█.█.█......███..█.█.█.█.█.█.█.█..██...█.█.█.█.█.█.█.█
..█..██..██..██.........█..██..██..██..██.....█..██..██..██..██.
███..█...█...█..........█..█...█...█...█....██...█...█...█...█..
................................................................
███...................███...................███.................
█....█.█.█.█.█.█........█..█.█.█.█.█.█.█.█..██...█.█.█.█.█.█....
███..██..██..██.........█..██..██..██..██...█....██..██..██.....
███..█...█...█..........█..█...█...█...█....███..█...█...█......
................................................................
................................................................
███..█..██..██..█.█...█.█...................███.................
█...█.█.█.█.█.█.█.█...███..█.█.█.█.█.█.█.█..██...█.█.█.█.█.█.█.█
█...███.██..██...█......█..██..██..██..██.....█..██..██..██..██.
███.█.█.█.█.█.█..█......█..█...█...█...█....██...█...█...█...█..
................................................................
███...................███...................███.................
█....█.█.█.█.█.█........█..█.█.█.█.█.█.█.█..██...█.█.█.█.█.█....
███..██..██..██.........█..██..██..██..██...█....██..██..██.....
███..█...█...█..........█..█...█...█...█....███..█...█...█......
................................................................
................................................................
███.███.█.█.███.██....███.███.........................█.█...███.
█.█..█..███.██..█.█...█...██...█.█.█.█............█.█.███.....█.
█.█..█..█.█.█...██....██..█....██..██.............█.█...█...██..
███..█..█.█.███.█.█...█...███..█...█...............█....█.█.███.
................................................................
`;


describe.only("ROM execute", () => {
    test.todo("pass all tests", async () => {
        const display = new NoDisplay();
        const emulator = new Emulator({
            display,
            delay: 0
        });
        emulator.run(Array.from(file));
        await new Promise(r => setTimeout(r, 16000));
        expect(display.state).toEqual(parseDisplay(resultScreenState));
    }, 17000);
});


